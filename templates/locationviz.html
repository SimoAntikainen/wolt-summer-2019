<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The HTML5 Herald</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>



</head>

<body>

  <div id="restaurant-map" style="width:1000px;height:500px;"></div>

  <button type="button" onclick="updateVisualization()">Try it</button>

  <form action="/visualizationdata" id="data-update-form" method="get">
    <div>
      <label for="Date">Date:</label>
      <input type="date" id="day-selected" name="day-selected"
        value="2019-01-07"
        min="2019-01-07" max="2019-01-13">
    </div>
    <div>
        <label for="start-time">Start time:</label>
        <input id="start-time" type="time" name="start-time" value="15:00">
    </div>
    <div>
        <label for="end-time">End time:</label>
        <input id="end-time" type="time" name="end-time" value="16:00">
    </div>
    <div class="button" id="data-update-button">
        <button type="submit" id="form-submit">Send your message</button>
      </div>
  </form>

  <script>

    function formatLocationText(plotJson) {
      var formattedLocation = []
      locations = Object.values(plotJson.location_id)
      medians = Object.values(plotJson.median)

      for (var i = 0; i < locations.length; i++) {
        var markerText = "id: " + locations[i] + " Md: " + medians[i] + ""
        formattedLocation.push(markerText)
      }

      return formattedLocation
    }

    function drawVisualization(plotJson) {
      TESTER = document.getElementById('restaurant-map');

          var trace1 = {
            x: Object.values(plotJson.longitude),
            y: Object.values(plotJson.latitude),
            mode: 'markers',
            type: 'scatter',
            text: formatLocationText(plotJson),
            textposition: 'top center',
            marker: {
              size: 10,
              color: Object.values(plotJson.median),
              colorbar: {
                title: "Median",
                dtick: 2
              }
            }
          };

          var data = [trace1];

          var layout = {
            title: 'Helsinki restaurant median pickup times',
            xaxis: {
            title: {
              text: 'Longitude',
              font: {
              family: 'Courier New, monospace',
              size: 18,
              color: '#7f7f7f'
              }
            },
            },
            yaxis: {
              title: {
                text: 'Latitude',
              font: {
              family: 'Courier New, monospace',
              size: 18,
              color: '#7f7f7f'
                }
              }
            }
          };

          Plotly.newPlot('restaurant-map', data, layout);
    }


    var initial_data = {}
    function initializeVisualization() {
      fetch('http://localhost:5000/visualizationdata')
        .then(function(response) {
          return response.json();
        })
        .then(function(plotJson) {
          drawVisualization(plotJson)
          console.log( JSON.stringify(plotJson))
          //print("adsds")
        })
    }

    initializeVisualization()

    $("#data-update-form").submit(function(e) {
      e.preventDefault()

      var form = $(this);  
      $.ajax({
           type: "GET",
           url: form.attr('action'),
           data: form.serialize(), // serializes the form's elements.
           success: function(data)
           {
             //drawVisualization(data.json())
               console.log(JSON.stringify(data)); // show response from the php script.
           }
         });

  });
    
  </script>


  <script>
      var a = {}
      function updateVisualization() {
        fetch('http://localhost:5000/defaultdata')
        .then(function(response) {
          return response.json();
        })
        .then(function(myJson) {
          a = JSON.stringify(myJson)
          
          printvals()
        });
      }

      function printvals() {
        console.log(a)
      }
    </script>

</body>



</html>